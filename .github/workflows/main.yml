name: virtual_classrooms

on:
  push:
    branches:
      - live

jobs:
  deploy:
    # Hier sagen Sie GitHub, dass der Job auf einem Ihrer eigenen Runner laufen soll
    runs-on: self-hosted 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build frontend application
        working-directory: ./frontend
        run: |
          echo "Installing dependencies and building..."
          npm install
          npm run build

      - name: Deploy to production directory
        run: |
          echo "Deploying application files..."
          # Der Zielordner auf Ihrem Server
          DESTINATION="/var/www/virtual_classrooms"
          
          # Erstellen Sie den Ordner, falls er nicht existiert
          mkdir -p $DESTINATION
          
          # Verwenden Sie rsync für effizientes Kopieren der Build-Artefakte
          # --delete sorgt dafür, dass alte Dateien im Ziel gelöscht werden
          rsync -av --delete ./frontend/.next $DESTINATION/
          rsync -av --delete ./frontend/public $DESTINATION/
          
          # Kopieren Sie die notwendigen Dateien, um Produktions-Abhängigkeiten zu installieren
          cp ./frontend/package.json $DESTINATION/
          cp ./frontend/package-lock.json $DESTINATION/
          # Optional, aber empfohlen, falls vorhanden
          # cp ./frontend/next.config.js $DESTINATION/
          
      - name: Install production dependencies and restart app
        run: |
          echo "Installing production dependencies and restarting server..."
          # Wechseln Sie in das Zielverzeichnis
          cd /var/www/virtual_classrooms
          
          # Installieren Sie nur die für die Produktion notwendigen Pakete
          npm install --production
          
          # Starten Sie die App mit PM2 oder laden Sie sie neu
          # 'pm2 reload' sorgt für ein Zero-Downtime-Deployment
          # 'ecosystem.config.js' ist der beste Weg, um PM2-Apps zu verwalten
          pm2 reload virtual_classrooms || pm2 start npm --name "virtual_classrooms" -- start
          
          echo "Deployment complete!"
